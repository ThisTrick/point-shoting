# Feature Specification: Візуальне шоу «Вистріл частинок → Картина»

**Feature Branch**: `001-`  
**Created**: 2025-09-25  
**Status**: Draft  
**Input**: User description: "Програма показує анімацію: серія вистрілів кольорових кульок із центру, хаотичний рух із фізичною вагою, поступове впорядкування в зображення (лого/фото) з передачею кольорових областей, фінальна стабільна композиція з легким \"диханням\". Керування: інтенсивність пострілу, кількість кульок, швидкість, хаос, тривалість фінальної паузи/зациклення, фон, режим колірної точності, локалізація, водяний знак, кнопки керування (Pause/Play, Restart, Skip to Final, Debug HUD). Ціль: 60 FPS, впізнаваність ≥80% за ≤10 c в середніх налаштуваннях." 

## Опис та Цінність
Функція дозволяє перетворити статичне зображення (брендове лого, ілюстрацію або фото) у видовищну кінематографічну анімацію «народження» з рою частинок. Це використовується для презентацій, заставок, шоу, інтерактивних демонстрацій, підсилюючи емоційний ефект та впізнаваність бренду.

## Основні Етапи Показу
1. Пре-старт: темний або заданий фон, легка пульсація центру (ефект очікування).
2. Постріли: з центральної області хвилями викидаються порції кольорових кульок (одна або кілька хвиль залежно від налаштувань інтенсивності).
3. Хаотичний рой: частинки рухаються в просторі, демонструючи інерцію, гальмування та взаємне уникання скупчень.
4. Навігація до образу: рух стає більш спрямованим; контури майбутньої картини поступово проступають.
5. Формування: частинки займають фінальні цільові позиції й наближені кольори зображення.
6. Фінальна стабілізація: картина «дихає» (мінімальні мікроколивання) без втрати форми; можливий зациклений режим або завершальна пауза.

## User Scenarios & Testing *(mandatory)*

### Primary User Story
Як оператор / ведучий презентації я завантажую зображення та запускаю анімацію, щоб аудиторія побачила захопливий ефект перетворення хаосу частинок у впізнаване лого/картинку протягом кількох секунд із подальшою стабільною демонстрацією.

### Acceptance Scenarios
1. **Given** завантажене валідне зображення і стандартні (середні) налаштування щільності, **When** оператор натискає Start, **Then** протягом ≤2 c з'являється стадія пострілу частинок і запускається послідовність етапів.
2. **Given** активна стадія «Хаос», **When** проходить визначений перехідний час, **Then** частинки поступово набувають впорядкованих траєкторій і контури зображення стають впізнаваними.
3. **Given** завершена стадія формування, **When** користувач натискає Pause, **Then** анімація мікрорухів зупиняється без втрати фінальної композиції.
4. **Given** будь-яка стадія до фіналу, **When** користувач натискає Skip to Final, **Then** система за ≤1 c переходить до стабільної фінальної композиції (без проміжних ривків) із валідними кольорами.
5. **Given** фінальна композиція, **When** увімкнено зациклення, **Then** після паузи сценарій (від пострілу) перезапускається коректно або (за обраним режимом) програється тільки «дихання» без руйнування.
6. **Given** натиснуто Restart під час будь-якої стадії, **Then** всі частинки повертаються до початкової логіки старту й цикл етапів відтворюється з початку.
7. **Given** велике зображення перевищує внутрішні ліміти обробки, **When** користувач намагається стартувати, **Then** система показує повідомлення із пропозицією зменшити щільність або масштаб (без аварійного завершення).
8. **Given** активований Debug HUD, **When** триває анімація, **Then** відображаються лічильник частинок, поточний етап та FPS (без впливу на плавність відчутно >5% втрати продуктивності) [NEEDS CLARIFICATION: допустиме падіння FPS при HUD].
9. **Given** встановлено водяний знак, **When** фінал досягнуто, **Then** водяний знак з'являється у вибраній позиції з налаштованою прозорістю.

### Edge Cases
- Завантажено зображення з повністю прозорими пікселями → прозорі області трактуються як фон; їх можуть заповнювати частинки у «стильному» режимі (не створюються «прозорі» частинки, але дозволений художній заповнювальний шар).
- Вузьке або дуже широке співвідношення сторін (наприклад панорама 5:1) → масштабування сцени без деформації впізнаваності.
- Дуже мале зображення (наприклад 32×32) → чи підвищувати щільність частинок для збереження естетики? [NEEDS CLARIFICATION]
- Надто висока щільність обрана користувачем → система повинна попередити про потенційне падіння FPS.
- Skip to Final під час першої секунди пострілу → чи миттєво «телепортуємо» всі частинки? (Потрібен плавний компроміс) [NEEDS CLARIFICATION]
- Повторне натискання Restart дуже швидко (спам) → система ігнорує надмірні запити або ставить у чергу.
- Зображення з обмеженою палітрою (монохром) → коректне відтворення без штучного «перефарбування».

## Requirements *(mandatory)*

### Functional Requirements
- **FR-001**: Система МАЄ дозволяти завантажити зображення у форматах PNG та JPG.
- **FR-002**: Система МАЄ адаптувати сцену під пропорції зображення (збереження співвідношення сторін без спотворень).
- **FR-003**: Система МАЄ генерувати серію «пострілів» частинок із центральної області згідно параметра інтенсивності (одна або кілька хвиль).
- **FR-004**: Система МАЄ забезпечити видиму фазу хаотичного руху (тривалість і ступінь хаосу налаштовуються).
- **FR-005**: Система МАЄ плавно переводити частинки з хаосу до впорядкованого формування цільового зображення.
- **FR-006**: Система МАЄ досягати впізнаваної форми (≥80% візуальної схожості за формою та кольорами) ≤10 с у «середніх» налаштуваннях щільності.
- **FR-007**: Система МАЄ підтримувати два режими колірної відповідності: «Стильний» (виразна узагальнена палітра) і «Точний» (максимальне наближення до вихідних тонів).
- **FR-008**: Система МАЄ виконати старт анімації (від натискання Start до появи першого пострілу) відповідно до цільового показника часу старту (див. NFR-002 для числового критерію).
- **FR-009**: Система МАЄ підтримувати контроль швидкості (мінімум три профілі: повільно / нормально / швидко).
- **FR-010**: Система МАЄ дозволяти вибір щільності частинок (низька / середня / висока) й попереджати про ризики продуктивності при високій.
- **FR-011**: Система МАЄ підтримувати цільову плавність кадрів (див. NFR-001 для конкретних метрик FPS) у середніх налаштуваннях на референсній машині.
- **FR-012**: Система МАЄ надавати керування: Pause/Play, Restart, Skip to Final.
// (ВИКЛЮЧЕНО) Раніше передбачена функція Save Export вилучена з обсягу функціональності на етапі уточнення.
- **FR-013**: Система МАЄ надавати фон: однотонний, градієнтний або завантажене зображення. Для фону-зображення МАЄ бути опціональний параметр `blur_strength` (ціле 0–25 px Gaussian радіус, за замовчуванням 0). Якщо `blur_strength` > 0, застосовується до фону один раз при ініціалізації.
- **FR-014**: Система МАЄ показувати фінальне «дихання» (мікроколивання) з максимальною амплітудою зміщення позиції частинки ≤3% від ширини сцени (у будь-якій осі), з плавним (синусоїдальним або перлин-ноїз) профілем, без втрати критеріїв впізнаваності (див. NFR-003).
- **FR-015**: Користувач МАЄ мати можливість увімкнути/вимкнути режим зациклення після фіналу.
- **FR-016**: Система МАЄ мати опціональний Debug HUD з лічильником частинок, етапом анімації, FPS. Увімкнення HUD НЕ МАЄ спричиняти середнього падіння FPS більш ніж на 5% (медіана FPS за 10 с при середній щільності) порівняно з режимом без HUD.
- **FR-017**: Debug HUD МАЄ бути вимкнений за замовчуванням.
- **FR-018**: Система МАЄ локалізувати текстові елементи щонайменше українською та англійською (перемикання без перезапуску).
- **FR-019**: Система МАЄ підтримувати накладання водяного знака в фіналі (позиція: кути + центр варіанти; регульована прозорість).
- **FR-020**: Система МАЄ коректно обробляти великі зображення: максимальна дозволена роздільність вхідного зображення 4096×4096 (або еквівалент, якщо сторони різні, обмеження по кожній осі ≤4096). Якщо будь-яка сторона >4096, система МАЄ відмовити у старті й показати повідомлення з рекомендацією зменшити роздільність/щільність.
- **FR-021**: Система МАЄ забезпечити відсутність візуальних артефактів (миготіння, різкі ривки) у всіх етапах.
- **FR-022**: Система МАЄ давати змогу змінити налаштування (крім вихідного зображення) між циклами без перезапуску програми.
- **FR-023**: При натисканні Skip to Final система МАЄ виконати плавний перехід (fade/організований «зліт») ≤1 c без хаотичного «стрибка».
- **FR-024**: При Restart усі внутрішні лічильники та стани етапів МАЮТЬ бути скинуті.
- **FR-025**: У разі недопустимого формату зображення система МАЄ вивести зрозуміле повідомлення та відхилити запуск.
- **FR-026**: Система МАЄ забезпечити узгодженість кількості частинок на всіх етапах (без неочікуваних втрат/подвоєнь). «Розчинення» (dissolve) частинок у поточному обсязі ЗАБОРОНЕНО (допустиме відхилення лічильника ≤0.5% лише через округлення/маскування прозорих пікселів).
- **FR-027**: Система МАЄ адаптувати сцену до пропорцій зображення та початкового розміру вікна перед стартом. Динамічне масштабування під час виконання не підтримується у цій версії (користувач отримує повідомлення про необхідність Restart для застосування нового розміру).
- **FR-028**: Система МАЄ обмежувати частоту команд керування (debounce): той самий тип команди (Pause/Play, Skip, Restart) не приймається частіше ніж раз на 150 мс; Restart має мінімальний інтервал 500 мс; Skip to Final — 300 мс.
- **FR-029**: Система МАЄ логічно завершувати цикл (фінал) навіть якщо проміжні параметри змінено під час виконання.
- **FR-030**: Система МАЄ трактувати повністю прозорі пікселі вихідного зображення як фон: не створювати цільові позиції частинок для них у «точному» режимі та дозволяти заповнення цих зон частинками у «стильному» режимі при необхідності композиційної цілісності.
- **FR-031**: Система МАЄ забезпечити плавний перехід Skip to Final: тривалість ≤1 с, позиції частинок інтерполюються зі Smoothstep easing, експоненційне демпфування швидкостей; жодна частинка не змінює позицію більше ніж на 10% ширини сцени між сусідніми кадрами в період переходу.
- **FR-032**: Система МАЄ забезпечити мінімальну коректність відтворення дрібних зображень: якщо будь-яка сторона <128 px, формується внутрішня «сітка цілей» з нормалізованим масштабуванням до мінімуму 128 px по меншій осі та гарантується мінімальна кількість частинок для профілю low ≥3000.
- **FR-033**: Водяний знак: приймається тільки PNG; мінімальна коротша сторона ≥64 px; масштаб водяного знака в фіналі ≤20% відповідного розміру сцени; прозорість (alpha) зберігається.
- **FR-034**: Валідація формату вхідного зображення: при не-PNG/JPG вхідному файлі система відмовляє в старті з повідомленням про підтримувані формати.
- **FR-035**: Зміна налаштувань (крім вихідного зображення) між циклами МАЄ застосовуватися без Restart; зміна критичних параметрів під час активного циклу (щільність, вихідне зображення) відхиляється з повідомленням.
- **FR-036**: Система МАЄ зберігати останні успішні налаштування між сесіями (persist) та відновлювати їх при запуску.
- **FR-037**: Система МАЄ визначати та відхиляти вхідні зображення, де будь-яка сторона >4096 px, до старту анімації (повідомлення + рекомендація зменшити роздільність/щільність).
- **FR-038**: Система МАЄ забезпечити роботу циклу до фіналу навіть при зміні некритичних налаштувань (колірний режим, HUD, локалізація) під час виконання.


### Нефункціональні Вимоги
- **NFR-001**: Плавність: середня FPS ≥55 (ціль 60) у середніх налаштуваннях (вимірюється як середня медіана по інтервалах в 120 с; 95-й перцентиль просідань не нижче 45 FPS).
- **NFR-002**: Час до початку видимої анімації (перший «постріл») ≤2 c від натискання Start.
- **NFR-003**: Впізнаваність фіналу: візуальна схожість ≥80%: (1) SSIM ≥0.75 між фінальним рендером (downscale до макс 512 px по більшій осі) і оригіналом; (2) ≥80% пікселів мають ΔE≤20 (CIEDE2000). Розрахунок метрик кожні 5 кадрів у стадіях CONVERGING/FORMATION.
- **NFR-004**: Стабільність: відсутність аварій при обробці зображень до 4096×4096; >4096 — гарантована передстартова відмова зі зрозумілим повідомленням.
- **NFR-005**: Інтерактивність: реакція на Pause/Play ≤200 мс (замір різниці часу між подією та замороженням симуляції).</n+- **NFR-006**: Локалізація: можливість додавання нових мов шляхом додавання нового файлу ресурсів без модифікації коду (динамічне завантаження + fallback на en-US).
- **NFR-007**: Плавність переходів: міжфазові зміни не викликають позиційних стрибків >10% ширини сцени в одному кадрі.
- **NFR-008**: Пам'ять: середній RSS процесу при середній щільності ≤300MB після стабілізації FORMATION (вимір через 5 с у FORMATION).
- **NFR-009**: Спостережуваність: структуроване логування (JSON або ключ=значення) та збір критичних помилок з опцією відправлення (opt-in) — каркас реалізовано.


### Key Entities
- **Image Source**: Завантажене користувацьке зображення; атрибути: роздільність, формат (PNG/JPG), прозорі області (прозорі пікселі ігноруються у точному режимі), співвідношення сторін.
- **Particle**: Окремий візуальний елемент (кулька); атрибути: поточна позиція, цільова позиція, колірний статус (стильний/точний), стан у фазі (хаос/перехід/фінал), радіус у межах діапазону.
- **Particle Set / Swarm**: Сукупність усіх частинок у сцені; атрибути: кількість, щільність профілю, розподіл кольорів.
- **Animation Stage**: Логічна фаза (Pre-start, Burst, Chaos, Converging, Formation, Final Breathing); атрибути: стартовий час, тривалість, умови переходу.
- **Scene Configuration**: Налаштування користувача; атрибути: фон (тип, параметри), швидкість профілю, інтенсивність пострілу, щільність, режим кольору, зациклення, параметри дихання, водяний знак.
- **User Controls**: Події керування (Start, Pause, Restart, Skip, Export, Toggle HUD).
- **Localization Bundle**: Колекція рядків інтерфейсу; атрибути: мова, ключ, текст.
- **Performance Metrics**: Дані для внутрішнього відстеження плавності (FPS усереднений, пікові просідання) [NEEDS CLARIFICATION: чи відображати користувачу].

### Залежності та Припущення
- Користувач має базовий комп'ютер із сучасним браузером / середовищем виконання (конкретні мінімальні параметри не визначені) [NEEDS CLARIFICATION: апаратні орієнтири].
- Вивід здійснюється в одному вікні (повноекранний або вбудований режим) — мультивіконність не потрібна.
- Зображення не містять забороненого контенту (фільтрація поза обсягом фічі).

### Пункти, Що Потребували Уточнення (Оновлено)
1. (ВИРІШЕНО) Метод оцінки впізнаваності → див. NFR-003.
2. (ВИРІШЕНО) Граничні розміри зображення → див. FR-037 / NFR-004.
3. (ВИЛУЧЕНО) Експорт поза обсягом.
4. (ВИРІШЕНО) Прозорі пікселі → див. FR-030.
5. (ВИРІШЕНО) Амплітуда «дихання» → FR-014.
6. (ВИРІШЕНО) HUD overhead ≤5% медіанного FPS падіння → FR-016.
7. (ВИРІШЕНО) Dissolve заборонено → FR-026.
8. (ВИРІШЕНО) Runtime resize не підтримується → FR-027.
9. (ВИРІШЕНО) Persistence ввімкнено → FR-036.
10. (ВИРІШЕНО) Вимоги водяного знака → FR-033.

### Глосарій / Glossary
| Термін (UA) | Canonical (EN) | Опис |
|-------------|----------------|------|
| Постріл | Burst | Фаза викиду порцій частинок |
| Хаос | Chaos | Фаза псевдовипадкового руху |
| Формування | Formation | Фаза укладання в кінцеве зображення |
| Фінальне дихання | Final Breathing | Легка мікроосциляція частинок |
| Впізнаваність | Recognition | Метрика подібності (SSIM + ΔE) |
| Рой | Swarm | Сукупність усіх частинок |
| Пропуск до фіналу | Skip to Final | Примусовий перехід до кінцевої композиції |


## Review & Acceptance Checklist
*GATE: Automated checks run during main() execution*

### Content Quality
- [ ] No implementation details (languages, frameworks, APIs)
- [ ] Focused on user value and business needs
- [ ] Written for non-technical stakeholders
- [ ] All mandatory sections completed

### Requirement Completeness
- [ ] No [NEEDS CLARIFICATION] markers remain
- [ ] Requirements are testable and unambiguous  
- [ ] Success criteria are measurable
- [ ] Scope is clearly bounded
- [ ] Dependencies and assumptions identified

## Execution Status
*Updated by main() during processing*

- [ ] User description parsed
- [ ] Key concepts extracted
- [ ] Ambiguities marked
- [ ] User scenarios defined
- [ ] Requirements generated
- [ ] Entities identified
- [ ] Review checklist passed

---

## Clarifications

### Session 2025-09-25
- Q: Який метод оцінки 80% візуальної впізнаваності фінального зображення слід використати як критерій переходу/успішності? → A: Комбінація SSIM≥0.75 + ≥80% пікселів ΔE≤20
- Q: Яка максимальна амплітуда «дихання» у фінальній стадії? → A: ≤3% від ширини сцени
- Q: Чи потрібен експорт (Save Export) кадру/кліпу? → A: Ні, експорт виключено з поточного обсягу
- Q: Який верхній граничний розмір зображення і політика при перевищенні? → A: Максимум 4096×4096; >4096 відмова + рекомендація
- Q: Як обробляти повністю прозорі пікселі? → A: Трактувати як фон; заповнюються стильними частинками опційно
